#!/bin/bash

set -e

SBCL_OPTS=(
    --dynamic-space-size "${APP_MEM-256}"
)

echo "---> Installing application source ..."
whoami
mkdir -vp ./quicklisp/local-projects/${APP_SYSTEM_NAME}
cp -Rf /tmp/src/. ./quicklisp/local-projects/${APP_SYSTEM_NAME}

echo "---> Building your Common Lisp application from source ..."
SBCL_OPTS=(
    "${SBCL_OPTS[@]}"
    --eval "(ql:quickload :$(eval echo ${APP_SYSTEM_NAME}))"
    --eval "(quit)"
)

echo sbcl "${SBCL_OPTS[@]}"
sbcl "${SBCL_OPTS[@]}"

chown -R 1001 ./quicklisp
